# Maintainer: Qingxu <me@linioi.com>
pkgname=switchhosts
pkgver=4.0.3
pkgrel=1
pkgdesc="An App for hosts management & switching."
arch=(
    'any'
    )
url="https://github.com/oldj/SwitchHosts"
license=('Apache')
provides=('switchhosts')
conflicts=(
    'switchhosts-bin'
    'switchhosts-appimage'
)
makedepends=(
    'nodejs'
    'electron'
    'npm'
)
source=(
    #"${pkgname}-${pkgver}.tar.gz::${url}/archive/v${pkgver}/SwitchHosts-v${pkgver}.tar.gz"
    "${pkgname}-${pkgver}.zip::${url}/archive/refs/heads/master.zip"
    )
sha256sums=(
    #'4a3ad76fa95103c4ba041a6220987d658fc57cb697cbbd0bdd43a66cd1b7cbff'
    '7bd4de59cb3fbfa3ffa621bc71a3a14f83ce6594d9619982427ebb49c82f8abf'
)

prepare() {
    # cd SwitchHosts-${pkgver}
    cd SwitchHosts-master

    # use system electron version
    # see: https://wiki.archlinux.org/index.php/Electron_package_guidelines
    sed -i "/electronDownload/,/}/d" scripts/make.js 
    sed -i "/directories/i\  electronVersion: $(electron --version | tail -c +2)," scripts/make.js
    sed -i "/directories/i\  electronDist: $(dirname $(realpath $(which electron)))," scripts/make.js
    # Set arch and target
    local i686=ia32 x86_64=x64 armv7h=armv7l aarch64=arm64
    sed -i "s/.*AppImage:x64.*$/    linux: ['pacman:build_arch'],/" scripts/make.js
    sed -i "s#build_arch#${!CARCH}#g" scripts/make.js
    sed -i "/await makeMacArm/d" scripts/make.js
}

build() {
    #cd SwitchHosts-${pkgver}
    cd SwitchHosts-master
    npm install
    npm run build
    npm run make
}

package() {
    cd ${srcdir}
    local i686=ia32 x86_64=x64 armv7h=armv7l aarch64=arm64
    tar -xvf SwitchHosts-master/dist/SwitchHosts-${!CARCH}.pacman -C ${pkgdir}
    rm -f ${pkgdir}/.PKGINFO ${pkgdir}/.MTREE ${pkgdir}/.INSTALL
}

post_install() {
    # Link to the binary
    ln -sf '/opt/SwitchHosts/switchhosts' '/usr/bin/switchhosts'
    # SUID chrome-sandbox for Electron 5+
    chmod 4755 '/opt/SwitchHosts/chrome-sandbox' || true
    update-mime-database /usr/share/mime || true
    update-desktop-database /usr/share/applications || true
}

post_remove() {
    rm -f '/usr/bin/switchhosts'
}
